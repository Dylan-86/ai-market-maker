<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>AI Market Maker</title>
  <link rel="stylesheet" href="styles.css?v3" />
</head>
<body>
  <div class="layout">
    <!-- LEFT: CHAT -->
    <div class="chat-column">
      <h1>AI Market Maker</h1>

      <div class="chat-box" id="chatHistory" aria-live="polite"></div>

      <!-- Use a real form; submit handles Enter and click uniformly -->
      <form id="chatForm" class="chat-input" autocomplete="off">
        <input
          id="userInput"
          name="userInput"
          type="text"
          placeholder="Type your questionâ€¦"
          aria-label="Your message"
          required
        />
        <button id="btnGenerate" type="submit">Send</button>
      </form>
      <div id="loader" class="loader" style="display: none;"></div>
    </div>

    <!-- RIGHT: PARSED DATA -->
    <aside class="data-column">
      <h2>Parsed Output</h2>
      <div class="parsed-data">
        <div><strong>Title:</strong><p id="title"></p></div>
        <div><strong>Description:</strong><p id="description"></p></div>
        <div><strong>Underlying Metric:</strong><p id="underlyingMetric"></p></div>
        <div><strong>URL:</strong><p id="url"></p></div>
        <div><strong>Score:</strong><p id="score"></p></div>
        <div><strong>Reason:</strong><p id="reason"></p></div>
      </div>
    </aside>
  </div>

  <script>
    const chatBox = document.getElementById("chatHistory");
    const inputEl = document.getElementById("userInput");
    const formEl = document.getElementById("chatForm");
    const sendBtn = document.getElementById("btnGenerate");
    const loader = document.getElementById("loader");

    let isSending = false;

    function appendBubble(text, who) {
      const div = document.createElement("div");
      div.className = `message ${who}`;
      div.textContent = text;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    async function handleSubmit(e) {
      e.preventDefault();
      if (isSending) return;

      const text = inputEl.value.trim();
      if (!text) return;

      isSending = true;
      sendBtn.disabled = true;
      loader.style.display = "block";

      appendBubble(text, "user");

      try {
        const res = await fetch("/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ user_input: text }),
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || "Server error");

        appendBubble(data.generated_text || "No response.", "ai");

        document.getElementById("title").textContent = data.title || "";
        document.getElementById("description").textContent = data.description || "";
        document.getElementById("underlyingMetric").textContent = data.underlying_metric || "";
        document.getElementById("url").textContent = data.url || "";
        document.getElementById("score").textContent = data.score || "";
        document.getElementById("reason").textContent = data.reason || "";
      } catch (err) {
        appendBubble("Error: " + err.message, "ai");
        console.error(err);
      } finally {
        inputEl.value = "";
        inputEl.focus();
        isSending = false;
        sendBtn.disabled = false;
        loader.style.display = "none";
      }
    }

    formEl.addEventListener("submit", handleSubmit);
  </script>
</body>
</html>
