<!DOCTYPE html>
<html>
<head>
    <title>AI Market Maker</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/@google/generative-ai@0.5.0/dist/index.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>AI Market Maker</h1>
        <label for="userInput">Enter your idea:</label><br>
        <input type="text" id="userInput" name="userInput"><br><br>
        <button onclick="getAIResponse()">Generate</button><br><br>

    <div class="output-section">
        <strong>Generated Text:</strong>
        <p id="generatedText"></p>
    </div>

    <div class="output-section">
        <strong>Description:</strong>
        <p id="description"></p>
    </div>

    <div class="output-section">
        <strong>URL:</strong>
        <p id="url"></p>
    </div>

    <script type="module">
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";
    
        const MODEL_NAME = "gemini-2.0-flash";
        let GEMINI_API_KEY = null;
        let genAI;
    
        async function fetchApiKey() {
            try {
                const response = await fetch('http://localhost:5000/get_api_key');
                const data = await response.json();
                GEMINI_API_KEY = data.api_key;
                if (GEMINI_API_KEY) {
                    genAI = new GoogleGenerativeAI(GEMINI_API_KEY);
                }
                return GEMINI_API_KEY;
            } catch (error) {
                console.error('Error fetching API key:', error);
                alert('Failed to fetch API key. Please check the backend.');
                return null;
            }
        }
    
        async function getAIResponse() {
            if (!genAI) {
                alert('API key not loaded. Please wait and try again.');
                return;
            }
            const userInput = document.getElementById("userInput").value;
    
            try {
                const instructionsResponse = await fetch('basic instructions.md');
                const instructions = await instructionsResponse.text();
    
                const model = genAI.getGenerativeModel({ model: MODEL_NAME });
    
                const prompt = `${instructions}\nUser Idea: ${userInput}\n\nOutput:`;
    
                const result = await model.generateContent(prompt);
                const response = await result.response;
                const generatedText = response.text();
    
                let description = "Parsing failed: Description not found.";
                let url = "Parsing failed: URL not found.";

                // Find the summary line which contains all the market data
                let summaryLine = "";
                const lines = generatedText.split('\n');
                for (const line of lines) {
                    if (line.includes("Market title:") && line.includes("Market description:")) {
                        summaryLine = line.trim().replace(/`/g, ''); // Clean backticks
                        break;
                    }
                }

                if (summaryLine) {
                    // Regex to extract the description between "Market description:" and the next key.
                    const descRegex = /Market description:(.*?)(Underlying metric \(URL\):|Interest rating:)/;
                    const descMatch = summaryLine.match(descRegex);
                    if (descMatch && descMatch[1]) {
                        description = descMatch[1].trim();
                    }

                    // Regex to find the first full URL in the summary line.
                    const urlRegex = /https?:\/\/[^\s]+/;
                    const urlMatch = summaryLine.match(urlRegex);
                    if (urlMatch) {
                        url = urlMatch[0];
                    }
                }
    
                document.getElementById("generatedText").innerText = generatedText;
                document.getElementById("description").innerText = description;
                document.getElementById("url").innerText = url;
    
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while fetching the AI response.');
            }
        }
    
        window.onload = async () => {
            await fetchApiKey();
        };
    
        // Make the function accessible from the global scope for the button's onclick
        window.getAIResponse = getAIResponse;
    </script>
</div>
</body>
</html>